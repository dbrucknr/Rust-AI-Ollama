<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Axum Rig SSE PoC</title>
    <script>
      const streamResponse = async () => {
        const inputValue = document.getElementById("query").value;
        const response = await fetch("http://localhost:8000/api/sse", {
          method: "POST",
          body: JSON.stringify({
            content: inputValue,
          }),
          headers: {
            "Content-Type": "application/json",
          },
          mode: "cors",
        });
        document.getElementById("query").value = "";
        document.getElementById("result").innerHTML = "";

        const reader = response.body
          .pipeThrough(new TextDecoderStream())
          .getReader();

        while (true) {
          const { value, done } = await reader.read();

          if (done) break;
          console.log("Received", value);
          console.log(typeof value);

          if (typeof value == "string") {
            if (value !== " ") {
              let cleaned = value.replace("data:", "").trimStart();
              document.getElementById("result").innerHTML += cleaned;
            }
          }
        }
      };

      {
        {
          /* if (typeof EventSource !== "undefined") {
        const source = new EventSource("http://localhost:8000/api");

        source.addEventListener("close", (event) => {
          console.log("event", event);
          source.close();
        });

        document.getElementById("result").innerHTML = "";

        source.onmessage = (event) => {
          if (event.data == "[done]") {
            source.close();
          } else {
            document.getElementById("result").innerHTML += event.data;
          }
        };

        source.onerror = (error) => console.error("EventSource error", error);
      } else {
        document.getElementById("result").innerHTML =
          "This browser doesn't support SSE's (Server Sent Events)";
      } */
        }
      }
    </script>
  </head>
  <body>
    <h1>SSE PoC</h1>
    <input
      type="text"
      id="query"
      name="query"
      required
      minlength="1"
      maxlength="255"
      size="10"
    />
    <button onclick="streamResponse()">Click Me</button>
    <div id="result">Waiting for server events...</div>
  </body>
</html>
